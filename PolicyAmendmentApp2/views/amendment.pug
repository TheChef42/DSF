extends layout

block content
  head
    link(rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css")
    style.
      .clear-both {
        clear: both;
      }
  body
    script(src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js")
    script(src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js")

    if error
      p.error-message(style="color: red;")= error

    if success
      p.success-message(style="color: green;")= success

    h1 Submit an amendment for the #{selectedPaper}

    div.container.paper
      each paper in papers
        a(href="/amendment/" + paper.name)
          button.large(class=paper.name == selectedPaper ? 'active' : '') #{paper.name}

    form(action="/submit-amendment" method="POST")
      label(for="æfNummer") ÆF Nummer:
      input(type="text" name="æfNummer" required)

      label(for="æfTilÆfNummer") ÆF til ÆF Nummer:
      input(type="text" name="æfTilÆfNummer" required)

      label(for="linjeFra") Linje fra:
      input(type="number" name="linjeFra")

      label(for="linjeTil") Linje til:
      input(type="number" name="linjeTil")

      label(for="stiller") Stiller:
      input(type="text" name="stiller" value=proposer readonly)

      label(for="medstillere") Medstillere:
      select(name="medstillere[]" multiple="multiple" class="select2" required)
        each org in organisations
          option(value=org.abbreviation)= org.name + ' - ' + org.university + ' (' + org.abbreviation + ')'

      label(for="typeAfÆf") Type af ÆF:
      select(name="typeAfÆf" required)
        option(value="tilføj") Tilføj
        option(value="erstat") Erstat
        option(value="slet") Slet

      label(for="oprindeligTekst") Oprindelig tekst:
      textarea(name="oprindeligTekst")

      label(for="nyTekst") Ny tekst:
      textarea(name="nyTekst")

      label(for="motivationForÆf") Motivation for ÆF:
      textarea(name="motivationForÆf")

      label(for="oprindeligTekstEngelsk") Oprindelig tekst (engelsk):
      textarea(name="oprindeligTekstEngelsk")

      label(for="nyTekstEngelsk") Ny tekst (engelsk):
      textarea(name="nyTekstEngelsk")

      label(for="motivationForÆfEngelsk") Motivation for ÆF (engelsk):
      textarea(name="motivationForÆfEngelsk")

      button(type="submit") Submit Amendment

    h1 Upload Amendments via Excel
    form(action="/upload" method="POST" enctype="multipart/form-data" class="upload-form" onsubmit="return validateFile()")
      input(type="file" name="file" id="fileInput" accept=".xls,.xlsx" required)
      button(type="submit" style="margin-right: 10px;") Upload
      a(href="/download-template/danish" style="margin-right: 10px;")
        button(type="button") Download Danish Template
      a(href="/download-template/english")
        button(type="button") Download English Template

    // Form to send amendments to server folder
    h1 Submitted Amendments
    form(action="/send-amendments" method="POST" class="send-amendments-form")
      button(type="submit" style="margin-right: 10px;") Submit Amendments
      button(type="button" class="button" onclick=`window.location.href='/submitted-amendments/${selectedPaper}'`) Go to Submitted Amendments

    // Clear float to prevent overlap
    div.clear-both

    h1 Amendments List
    button(type="button" style="background-color: red; color: white; margin-bottom: 10px;" onclick="deleteAllAmendments()") Delete All
    table
      tr
        th ÆF Nummer
        th Indskrivning
        th Modstridende med
        th Linje fra
        th Linje til
        th Stiller
        th Medstiller
        th Type af ÆF
        th Oprindelig tekst
        th Ny tekst
        th Motivation for ÆF
        th Actions
      each amendment in amendments
        tr
          td= amendment.amendment_number
          td= amendment.write_in
          td= amendment.conflicting_with
          td= amendment.line_from
          td= amendment.line_to
          td= amendment.proposer
          td= amendment.co_proposer
          td= amendment.amendment_type
          td= amendment.original_text_danish
          td= amendment.new_text_danish
          td= amendment.motivation_danish
          td
            button(type="button" style="background-color: red; color: white;" onclick=`deleteAmendment(${amendment.id})`) Delete

    // Modal for file validation alert
    div#overlay(style="display: none;")
      div#fileErrorModal.modal
        div.modal-content
          span.close-button(onclick="closeModal()") &times;
          h2.modal-title Error: Invalid File
          p Please upload a valid .xls or .xlsx file.
          div.modal-buttons
            a(href="/download-template/danish" target="_blank")
              button(type="button") Download Danish Template
            a(href="/download-template/english" target="_blank")
              button(type="button") Download English Template

    script.
      $(document).ready(function () {
        function formatOrg(org) {
          if (!org.id) {
            return org.text;
          }
          const text = $(org.element).text();
          return $('<span>' + text + '</span>');
        }

        function formatOrgSelection(org) {
          return org.id;
        }

        $('.select2').select2({
          templateResult: formatOrg,
          templateSelection: formatOrgSelection
        });
      });

      function deleteAmendment(id) {
        if (confirm('Are you sure you want to delete this amendment?')) {
          fetch(`/amendment/delete/${id}`, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json'
            }
          })
                  .then(response => {
                    if (response.ok) {
                      location.reload();
                    } else {
                      alert('Error deleting amendment');
                    }
                  })
                  .catch(error => {
                    console.error('Error:', error);
                    alert('Error deleting amendment');
                  });
        }
      }
      function validateFile() {
        const fileInput = document.getElementById('fileInput');
        const filePath = fileInput.value;
        const allowedExtensions = /(\.xls|\.xlsx)$/i;

        if (!allowedExtensions.exec(filePath)) {
          // Show the custom modal popup and overlay
          document.getElementById('overlay').style.display = 'flex';
          fileInput.value = ''; // Reset the file input
          return false;
        }
        return true;
      }

      function closeModal() {
        // Hide the custom modal and overlay
        document.getElementById('overlay').style.display = 'none';
      }

      function deleteAllAmendments() {
        if (confirm('Are you sure you want to delete all visible amendments?')) {
          fetch('/amendment/delete-all', {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json'
            }
          })
                  .then(response => {
                    if (response.ok) {
                      location.reload();
                    } else {
                      alert('Error deleting amendments');
                    }
                  })
                  .catch(error => {
                    console.error('Error:', error);
                    alert('Error deleting amendments');
                  });
        }
      }